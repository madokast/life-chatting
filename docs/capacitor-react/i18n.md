# 国际化 (i18n) 实现指南

## 概述

本项目采用轻量级的自定义国际化解决方案，无需引入 i18next 等第三方库。通过单例模式的 I18n 类实现全局国际化管理，支持中文和英文两种语言，具备完整的 TypeScript 类型定义和响应式更新机制。

### 核心特性

- **轻量级**：完全自定义实现，无第三方依赖
- **类型安全**：完整的 TypeScript 类型定义
- **响应式**：订阅者模式实现语言变化自动更新
- **持久化**：语言设置保存到 localStorage
- **可扩展**：架构支持轻松添加新语言
- **简洁易用**：API 简单直观

## 架构设计

### 目录结构

```
capacitor-react/src/
├── i18n/
│   ├── i18n.ts          # 国际化核心类（单例模式）
│   └── locales.ts       # 语言包定义
├── config/
│   └── UserConfig.ts    # 用户配置管理（包含语言设置）
└── components/
    ├── App.tsx          # 应用主入口（初始化国际化）
    └── Drawer.tsx       # 抽屉菜单（语言切换示例）
```

### 核心组件

#### 1. 语言包定义 ([locales.ts](../../capacitor-react/src/i18n/locales.ts))

```typescript
export type Language = 'zh' | 'en'

export interface Translations {
  app: {
    title: string
  }
  nav: {
    diary: string
    chat: string
    settings: string
  }
  drawer: {
    postCount: string
    appName: string
    appearance: string
    appearanceLight: string
    appearanceDark: string
    language: string
    languageZh: string
    languageEn: string
  }
}

export const locales: Record<Language, Translations> = {
  zh: {
    app: { title: 'Life Chatting' },
    nav: { diary: '日记', chat: '聊天', settings: '设置' },
    drawer: {
      postCount: '日记 15 条',
      appName: 'Life Chatting',
      appearance: '显示样式',
      appearanceLight: '浅色',
      appearanceDark: '深色',
      language: '语言',
      languageZh: '中文',
      languageEn: 'En'
    }
  },
  en: {
    app: { title: 'Life Chatting' },
    nav: { diary: 'Diary', chat: 'Chat', settings: 'Settings' },
    drawer: {
      postCount: 'Diary 15 posts',
      appName: 'Life Chatting',
      appearance: 'Appearance',
      appearanceLight: 'Light',
      appearanceDark: 'Dark',
      language: 'Language',
      languageZh: '中文',
      languageEn: 'En'
    }
  }
}
```

#### 2. 国际化核心类 ([i18n.ts](../../capacitor-react/src/i18n/i18n.ts))

```typescript
class I18n {
  private static instance: I18n
  private currentLanguage: Language = 'zh'
  private listeners: Set<() => void> = new Set()

  static getInstance(): I18n
  
  getLanguage(): Language
  setLanguage(language: Language): void
  t(key: string): string
  subscribe(listener: () => void): () => void
}

export const i18n = I18n.getInstance()
```

**核心方法说明：**

- `t(key: string)`: 翻译函数，支持点号分隔符访问嵌套键（如 `t('nav.diary')`）
- `setLanguage(language: Language)`: 设置当前语言，并通知所有订阅者
- `subscribe(listener: () => void)`: 订阅语言变化，返回取消订阅函数
- `getLanguage()`: 获取当前语言

#### 3. 用户配置管理 ([UserConfig.ts](../../capacitor-react/src/config/UserConfig.ts))

```typescript
class UserConfig {
  getLanguage(): Language
  setLanguage(language: Language): void
  private saveToStorage(): void
  private loadFromStorage(): void
}
```

负责管理用户的语言偏好设置，使用 localStorage 持久化存储。

## 使用方式

### 基本使用

在组件中导入 i18n 实例并使用：

```typescript
import { i18n } from '../i18n/i18n'

function MyComponent() {
  return (
    <div>
      <h1>{i18n.t('app.title')}</h1>
      <p>{i18n.t('nav.diary')}</p>
    </div>
  )
}
```

### 响应式更新

如果组件需要在语言变化时自动更新，需要订阅语言变化：

```typescript
import { useState, useEffect } from 'react'
import { i18n } from '../i18n/i18n'

function MyComponent() {
  const [, forceUpdate] = useState({})

  useEffect(() => {
    const unsubscribe = i18n.subscribe(() => {
      forceUpdate({})
    })
    return unsubscribe
  }, [])

  return (
    <div>
      <h1>{i18n.t('app.title')}</h1>
    </div>
  )
}
```

### 语言切换

在设置页面提供语言切换功能：

```typescript
const handleLanguageToggle = () => {
  const newLanguage = currentLanguage === 'zh' ? 'en' : 'zh'
  userConfig.setLanguage(newLanguage)
  i18n.setLanguage(newLanguage)
}
```

## 开发指南

### 1. 遇到新文本时的处理流程

当在开发过程中遇到需要国际化的新文本时，按照以下步骤操作：

#### 步骤一：在 locales.ts 中添加翻译

打开 `src/i18n/locales.ts` 文件，在 `Translations` 接口中添加新的翻译键：

```typescript
export interface Translations {
  app: { title: string }
  nav: { diary: string; chat: string; settings: string }
  drawer: { ... }
  // 新增的翻译键
  myNewFeature: {
    title: string
    description: string
    buttonText: string
  }
}
```

然后在 `locales` 对象中为每种语言添加翻译：

```typescript
export const locales: Record<Language, Translations> = {
  zh: {
    // ... 现有翻译
    myNewFeature: {
      title: '我的新功能',
      description: '这是一个新功能的描述',
      buttonText: '点击我'
    }
  },
  en: {
    // ... 现有翻译
    myNewFeature: {
      title: 'My New Feature',
      description: 'This is a description of a new feature',
      buttonText: 'Click Me'
    }
  }
}
```

#### 步骤二：在组件中使用 i18n.t()

在需要显示文本的组件中，使用 `i18n.t()` 替代硬编码文本：

```typescript
import { i18n } from '../i18n/i18n'

function MyNewFeature() {
  return (
    <div>
      <h2>{i18n.t('myNewFeature.title')}</h2>
      <p>{i18n.t('myNewFeature.description')}</p>
      <button>{i18n.t('myNewFeature.buttonText')}</button>
    </div>
  )
}
```

#### 步骤三：确保组件响应语言变化（可选）

如果组件需要在语言切换时自动更新，添加订阅逻辑：

```typescript
import { useState, useEffect } from 'react'
import { i18n } from '../i18n/i18n'

function MyNewFeature() {
  const [, forceUpdate] = useState({})

  useEffect(() => {
    const unsubscribe = i18n.subscribe(() => {
      forceUpdate({})
    })
    return unsubscribe
  }, [])

  return (
    <div>
      <h2>{i18n.t('myNewFeature.title')}</h2>
      <p>{i18n.t('myNewFeature.description')}</p>
      <button>{i18n.t('myNewFeature.buttonText')}</button>
    </div>
  )
}
```

### 2. 新增带有文本的组件时的引入方法

当创建新的组件且组件中包含需要国际化的文本时，按照以下步骤操作：

#### 步骤一：导入 i18n

在组件文件顶部导入 i18n 实例：

```typescript
import { i18n } from '../i18n/i18n'
```

#### 步骤二：使用 i18n.t() 替代硬编码文本

将所有硬编码的文本替换为 `i18n.t()` 调用：

```typescript
// ❌ 错误做法：硬编码文本
function MyComponent() {
  return (
    <div>
      <h1>欢迎</h1>
      <p>这是一个新组件</p>
      <button>提交</button>
    </div>
  )
}

// ✅ 正确做法：使用国际化
function MyComponent() {
  return (
    <div>
      <h1>{i18n.t('myComponent.welcome')}</h1>
      <p>{i18n.t('myComponent.description')}</p>
      <button>{i18n.t('myComponent.submit')}</button>
    </div>
  )
}
```

#### 步骤三：添加语言订阅（推荐）

为了让组件在语言切换时自动更新，添加订阅逻辑：

```typescript
import { useState, useEffect } from 'react'
import { i18n } from '../i18n/i18n'

function MyComponent() {
  const [, forceUpdate] = useState({})

  useEffect(() => {
    const unsubscribe = i18n.subscribe(() => {
      forceUpdate({})
    })
    return unsubscribe
  }, [])

  return (
    <div>
      <h1>{i18n.t('myComponent.welcome')}</h1>
      <p>{i18n.t('myComponent.description')}</p>
      <button>{i18n.t('myComponent.submit')}</button>
    </div>
  )
}
```

#### 步骤四：在 locales.ts 中添加翻译

按照"遇到新文本时的处理流程"中的步骤一，在 `locales.ts` 中添加对应的翻译。

## 最佳实践

### 命名规范

#### 翻译键命名

- 使用点号分隔符表示层级关系
- 使用小驼峰命名法（camelCase）
- 按功能模块组织翻译键

```typescript
// ✅ 推荐的命名方式
nav.diary
nav.chat
settings.appearance
settings.language
myFeature.title
myFeature.description

// ❌ 不推荐的命名方式
nav_diary
NAV_CHAT
settings_appearance_light
```

#### 翻译键组织

按功能模块和页面层级组织翻译键：

```typescript
export interface Translations {
  // 应用级别
  app: {
    title: string
    version: string
  }

  // 导航栏
  nav: {
    diary: string
    chat: string
    settings: string
  }

  // 设置页面
  settings: {
    title: string
    appearance: string
    language: string
    about: string
  }

  // 功能模块
  diary: {
    title: string
    create: string
    edit: string
    delete: string
  }
}
```

### 翻译文本规范

- 保持简洁明了，避免过长的翻译文本
- 使用一致的术语和表达方式
- 考虑不同语言的文本长度差异
- 对于动态内容，使用参数化翻译（未来扩展）

### 组件开发规范

#### 必须国际化的场景

- 所有用户可见的文本
- 按钮标签、菜单项、标题
- 错误提示、成功消息
- 表单标签、占位符

#### 不需要国际化的场景

- 技术术语（如 API、URL、HTTP）
- 产品名称（如 Life Chatting）
- 代码标识符
- 日志信息

#### 组件模板

创建新组件时，使用以下模板：

```typescript
import { useState, useEffect } from 'react'
import { i18n } from '../i18n/i18n'

interface MyComponentProps {
  // 组件属性定义
}

export function MyComponent({ ... }: MyComponentProps) {
  const [, forceUpdate] = useState({})

  useEffect(() => {
    const unsubscribe = i18n.subscribe(() => {
      forceUpdate({})
    })
    return unsubscribe
  }, [])

  return (
    <div>
      {/* 使用 i18n.t() 替代所有硬编码文本 */}
    </div>
  )
}
```

### 性能优化

- 避免在渲染循环中频繁调用 `i18n.t()`
- 对于静态文本，可以在组件外部缓存翻译结果
- 合理使用订阅机制，避免不必要的重新渲染

```typescript
// ✅ 推荐：在组件外部缓存
const WELCOME_TEXT = i18n.t('myComponent.welcome')

function MyComponent() {
  return <h1>{WELCOME_TEXT}</h1>
}

// ❌ 不推荐：在渲染循环中频繁调用
function MyComponent() {
  return (
    <div>
      {Array(100).fill(0).map((_, i) => (
        <div key={i}>{i18n.t('common.item')}</div>
      ))}
    </div>
  )
}
```

## 扩展指南

### 添加新语言

如需添加新语言（如日语、法语等），按照以下步骤：

1. 在 `Language` 类型中添加新语言代码：

```typescript
export type Language = 'zh' | 'en' | 'ja' | 'fr'
```

2. 在 `locales` 对象中添加新语言的翻译：

```typescript
export const locales: Record<Language, Translations> = {
  zh: { ... },
  en: { ... },
  ja: {
    app: { title: 'Life Chatting' },
    nav: { diary: '日記', chat: 'チャット', settings: '設定' },
    // ... 其他翻译
  },
  fr: {
    app: { title: 'Life Chatting' },
    nav: { diary: 'Journal', chat: 'Chat', settings: 'Paramètres' },
    // ... 其他翻译
  }
}
```

3. 更新语言切换逻辑以支持新语言

### 参数化翻译（未来扩展）

如需支持参数化翻译（如 `Hello, ${name}!`），可以扩展 `t()` 方法：

```typescript
t(key: string, params?: Record<string, any>): string {
  const text = this.getTranslation(key)
  if (!params) return text
  
  return text.replace(/\{(\w+)\}/g, (match, param) => {
    return params[param] || match
  })
}

// 使用方式
i18n.t('greeting', { name: 'John' })
// 翻译文本: "Hello, {name}!" → "Hello, John!"
```

## 常见问题

### Q: 为什么不使用 i18next？

A: 本项目采用轻量级的自定义实现，具有以下优势：
- 无需引入额外的第三方依赖
- 代码更简洁，易于理解和维护
- 完全控制国际化逻辑，便于定制
- 对于中小型项目足够使用

### Q: 如何处理翻译缺失的情况？

A: 当翻译键不存在时，`i18n.t()` 会返回原始的 key，确保应用不会崩溃。建议在开发时检查所有翻译键是否完整。

### Q: 组件必须订阅语言变化吗？

A: 不是必须的。如果组件不需要在语言切换时自动更新，可以不订阅。但为了用户体验，建议所有包含用户可见文本的组件都订阅语言变化。

### Q: 如何在非 React 环境中使用 i18n？

A: i18n 是一个纯 JavaScript 类，可以在任何 JavaScript 环境中使用：

```typescript
import { i18n } from './i18n/i18n'

console.log(i18n.t('app.title'))
i18n.setLanguage('en')
console.log(i18n.t('app.title'))
```

## 参考资源

- [i18n.ts](../../capacitor-react/src/i18n/i18n.ts) - 国际化核心类实现
- [locales.ts](../../capacitor-react/src/i18n/locales.ts) - 语言包定义
- [UserConfig.ts](../../capacitor-react/src/config/UserConfig.ts) - 用户配置管理
- [App.tsx](../../capacitor-react/src/App.tsx) - 应用初始化示例
- [Drawer.tsx](../../capacitor-react/src/components/Drawer.tsx) - 语言切换示例
